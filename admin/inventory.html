<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qu·∫£n l√Ω t·ªìn kho - ƒêƒÉng ƒê·∫°i Bakery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/admin_style.css">
  <style>
    body.dark .modal-content { background: #2b2b3a; color: #f5f5f5; }
    body.dark .form-control, body.dark .form-select { background-color: #1e1e2d; color: #f5f5f5; border-color: #444; }
    #toastContainer { position: fixed; top: 1rem; right: 1rem; z-index: 9999; }
    #loadingSpinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none; }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="brand"><i class="fa-solid fa-cake-candles me-2"></i>ƒêƒÉng ƒê·∫°i Admin</div>
    <a href="dashboard.html"><i class="fa-solid fa-chart-line me-2"></i>Dashboard</a>
    <a href="products.html"><i class="fa-solid fa-bread-slice me-2"></i>S·∫£n ph·∫©m</a>
    <a href="orders.html"><i class="fa-solid fa-box me-2"></i>ƒê∆°n h√†ng</a>
    <a href="users.html"><i class="fa-solid fa-users me-2"></i>Kh√°ch h√†ng</a>
    <a href="inventory.html" class="active"><i class="fa-solid fa-warehouse me-2"></i>T·ªìn kho</a>
    <a href="login.html" class="text-danger"><i class="fa-solid fa-right-from-bracket me-2"></i>ƒêƒÉng xu·∫•t</a>
  </div>

  <!-- Main -->
  <div class="main-content">
    <div class="navbar mb-4">
      <h5 class="fw-bold text-danger mb-0"><i class="fa-solid fa-warehouse me-2"></i>Qu·∫£n l√Ω t·ªìn kho</h5>
      <div class="d-flex align-items-center gap-3">
        <button id="themeToggle" class="theme-toggle"><i class="fa-solid fa-moon"></i></button>
        <span class="text-muted small">Xin ch√†o, <b>Admin</b></span>
        <img src="https://i.pravatar.cc/40?img=54" class="rounded-circle" alt="Admin">
      </div>
    </div>

    <div class="container-fluid" data-aos="fade-up">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <button class="btn btn-outline-danger" id="addItemBtn"><i class="fa-solid fa-plus"></i> Th√™m s·∫£n ph·∫©m</button>
          <button class="btn btn-outline-secondary" id="refreshData"><i class="fa-solid fa-rotate"></i> T·∫£i l·∫°i</button>
        </div>
        <div class="d-flex gap-2">
          <input id="searchItem" class="form-control" placeholder="üîç T√¨m theo t√™n / m√£ / lo·∫°i...">
          <select id="filterStatus" class="form-select w-auto">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="ok">C√≤n h√†ng</option>
            <option value="low">S·∫Øp h·∫øt</option>
            <option value="out">H·∫øt h√†ng</option>
          </select>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>M√£ SP</th><th>T√™n s·∫£n ph·∫©m</th><th>Lo·∫°i</th><th>Gi√°</th><th>S·ªë l∆∞·ª£ng</th><th>Ng√†y nh·∫≠p</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="inventoryBody"></tbody>
            </table>
          </div>
          <nav class="mt-3">
            <ul class="pagination justify-content-center" id="pagination"></ul>
          </nav>
        </div>
      </div>
    </div>

    <!-- Modal th√™m/s·ª≠a -->
    <div class="modal fade" id="itemModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title fw-bold">Th√™m s·∫£n ph·∫©m</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="itemForm">
              <input type="hidden" id="itemId">
              <div class="mb-3"><label class="form-label">T√™n s·∫£n ph·∫©m</label><input id="itemName" class="form-control" required></div>
              <div class="mb-3"><label class="form-label">Lo·∫°i</label><input id="itemCategory" class="form-control" required></div>
              <div class="mb-3"><label class="form-label">Gi√° (‚Ç´)</label><input id="itemPrice" type="number" class="form-control" required></div>
              <div class="mb-3"><label class="form-label">S·ªë l∆∞·ª£ng</label><input id="itemQuantity" type="number" min="0" class="form-control" required></div>
              <div class="mb-3"><label class="form-label">Ng√†y nh·∫≠p</label><input id="itemDate" type="date" class="form-control" required></div>
            </form>
          </div>
          <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button><button class="btn btn-danger" id="saveItem">L∆∞u</button></div>
        </div>
      </div>
    </div>

    <footer class="mt-5 small text-center">¬© 2025 ƒêƒÉng ƒê·∫°i Bakery Admin</footer>
  </div>

  <div id="toastContainer"></div>
  <div id="loadingSpinner"><div class="spinner-border text-danger" style="width:3rem;height:3rem;"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <script>
  AOS.init();

  /* üåô Dark mode */
  const themeBtn=document.getElementById('themeToggle');
  if(localStorage.getItem('theme')==='dark'){document.body.classList.add('dark');themeBtn.innerHTML='<i class="fa-solid fa-sun"></i>';}
  themeBtn.onclick=()=>{document.body.classList.toggle('dark');const dark=document.body.classList.contains('dark');themeBtn.innerHTML=dark?'<i class="fa-solid fa-sun"></i>':'<i class="fa-solid fa-moon"></i>';localStorage.setItem('theme',dark?'dark':'light');};

  const showLoading=(s=true)=>{document.getElementById('loadingSpinner').style.display=s?'flex':'none';};
  function showToast(msg,type='success'){
    const c=document.getElementById('toastContainer');
    const color=type==='success'?'bg-success':'bg-danger';
    const t=document.createElement('div');
    t.className=`toast align-items-center text-white ${color} border-0 show mb-2`;
    t.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto"></button></div>`;
    c.appendChild(t); setTimeout(()=>t.remove(),3000);
  }

  const CAKE_FILES=['bonglan','donut','cookies','macaron','tiramisu'];
  let inventory=JSON.parse(localStorage.getItem('inventory'))||[];

  async function loadFromFiles(){
    showLoading(true);
    const all=[];
    for(const f of CAKE_FILES){
      try{
        const res = await fetch(`../cakes/${f}.html`);
        const html = await res.text();
        const div = document.createElement('div'); div.innerHTML = html;
        div.querySelectorAll('.product-item').forEach(p=>{
          const name=p.querySelector('.card-title')?.textContent.trim();
          const price=parseInt(p.dataset.price)||0;
          const id='SP'+(Math.floor(Math.random()*9000)+1000);
          all.push({id,name,category:f,price,qty:Math.floor(Math.random()*20),date:'2025-10-16'});
        });
      }catch(err){console.warn('Kh√¥ng t·∫£i ƒë∆∞·ª£c',f);}
    }
    if(inventory.length===0){inventory=all; localStorage.setItem('inventory',JSON.stringify(inventory));}
    showLoading(false); renderItems(filterItems());
  }

  const tbody=document.getElementById('inventoryBody');
  const pagination=document.getElementById('pagination');
  let currentPage=1, perPage=5;

  function getStatus(qty){
    if(qty<=0) return {text:'H·∫øt h√†ng',cls:'danger'};
    if(qty<=5) return {text:'S·∫Øp h·∫øt',cls:'warning'};
    return {text:'C√≤n h√†ng',cls:'success'};
  }

  function filterItems(){
    const k=document.getElementById('searchItem').value.toLowerCase();
    const st=document.getElementById('filterStatus').value;
    return inventory.filter(i=>{
      return (i.name+i.id+i.category).toLowerCase().includes(k)
      &&(st===''||(st==='ok'&&i.qty>5)||(st==='low'&&i.qty>0&&i.qty<=5)||(st==='out'&&i.qty<=0));
    });
  }

  function renderItems(list){
    tbody.innerHTML='';
    const start=(currentPage-1)*perPage, data=list.slice(start,start+perPage);
    data.forEach(i=>{
      const s=getStatus(i.qty);
      tbody.innerHTML+=`
      <tr>
        <td>${i.id}</td><td>${i.name}</td><td>${i.category}</td><td>${i.price.toLocaleString()} ‚Ç´</td>
        <td>${i.qty}</td><td>${i.date}</td>
        <td><span class="badge bg-${s.cls}">${s.text}</span></td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="${i.id}"><i class="fa-solid fa-pen"></i></button>
          <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${i.id}"><i class="fa-solid fa-trash"></i></button>
        </td>
      </tr>`;
    });
    renderPagination(list);
  }

  function renderPagination(list){
    const total=Math.max(1,Math.ceil(list.length/perPage));
    pagination.innerHTML='';
    for(let i=1;i<=total;i++){
      pagination.innerHTML+=`<li class="page-item ${i===currentPage?'active':''}"><button class="page-link">${i}</button></li>`;
    }
    pagination.querySelectorAll('button').forEach((b,idx)=>b.onclick=()=>{currentPage=idx+1;renderItems(filterItems());});
  }

  document.getElementById('searchItem').addEventListener('input',()=>renderItems(filterItems()));
  document.getElementById('filterStatus').onchange=()=>renderItems(filterItems());
  document.getElementById('refreshData').onclick=()=>{localStorage.removeItem('inventory');location.reload();};

  const modal=new bootstrap.Modal('#itemModal');
  document.getElementById('addItemBtn').onclick=()=>{
    document.querySelector('#itemModal .modal-title').textContent='Th√™m s·∫£n ph·∫©m';
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value='';
    modal.show();
  };

  document.addEventListener('click',e=>{
    const id=e.target.closest('[data-id]')?.dataset.id; if(!id)return;
    const idx=inventory.findIndex(i=>i.id===id), it=inventory[idx];
    if(e.target.closest('.edit-btn')){
      document.querySelector('#itemModal .modal-title').textContent='Ch·ªânh s·ª≠a s·∫£n ph·∫©m';
      document.getElementById('itemId').value=it.id;
      document.getElementById('itemName').value=it.name;
      document.getElementById('itemCategory').value=it.category;
      document.getElementById('itemPrice').value=it.price;
      document.getElementById('itemQuantity').value=it.qty;
      document.getElementById('itemDate').value=it.date;
      modal.show();
    }
    if(e.target.closest('.delete-btn')){
      if(confirm('X√≥a s·∫£n ph·∫©m '+it.name+'?')){
        showLoading(); setTimeout(()=>{
          inventory.splice(idx,1); saveItems(); renderItems(filterItems());
          showToast('ƒê√£ x√≥a s·∫£n ph·∫©m','error'); showLoading(false);
        },500);
      }
    }
  });

  document.getElementById('saveItem').onclick=()=>{
    showLoading();
    setTimeout(()=>{
      const id=document.getElementById('itemId').value||'SP'+Date.now().toString().slice(-4);
      const name=document.getElementById('itemName').value.trim();
      const cat=document.getElementById('itemCategory').value.trim();
      const price=parseInt(document.getElementById('itemPrice').value)||0;
      const qty=parseInt(document.getElementById('itemQuantity').value)||0;
      const date=document.getElementById('itemDate').value;
      if(!name||!cat||!date){showToast('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!','error');showLoading(false);return;}
      const newItem={id,name,category:cat,price,qty,date};
      const idx=inventory.findIndex(i=>i.id===id);
      if(idx>-1){inventory[idx]=newItem;showToast('ƒê√£ c·∫≠p nh·∫≠t s·∫£n ph·∫©m');}
      else{inventory.unshift(newItem);showToast('ƒê√£ th√™m s·∫£n ph·∫©m m·ªõi');}
      saveItems(); modal.hide(); renderItems(filterItems());
      showLoading(false);
    },600);
  };

  const saveItems=()=>localStorage.setItem('inventory',JSON.stringify(inventory));

  // ‚úÖ ch·ªâ g·ªçi 1 l·∫ßn loadFromFiles
  (async () => {
    await loadFromFiles();
  })();
  </script>
</body>
</html>
